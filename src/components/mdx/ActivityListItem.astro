---
import type { Activity } from "@data/activities";
import { getEntry } from "astro:content";
import moment from "moment";
import { parseSlug } from "@scripts/utils";

// showWorkTitle is false for filtered list in each post
const { data, showWorkTitle = false } = Astro.props as {
  data: Activity;
  showWorkTitle?: boolean;
};
const { slug, date, title, role, place, city, country, link } = data;

// some entries may not have corresponding post slug.
// some activity may have multiple slugs associated with it
const slugArray = slug ? (Array.isArray(slug) ? slug : [slug]) : [];
const entries = await Promise.all(
  slugArray.map(async (s) => {
    const workEntry = await getEntry("work", s);
    if (workEntry) return workEntry;
    return await getEntry("documentation", s) ?? null;
  })
);
const filteredEntries = entries.filter(Boolean);
const workTitles = filteredEntries.map((e) => e!.data.title);
const postLinks = filteredEntries.map((e) => {
  const prefix = e!.collection === "documentation" ? "/documentation/" : "/";
  return `${prefix}${parseSlug(e!.slug)}`;
});
---

<li role="listitem" class="">
  {showWorkTitle && workTitles.length > 0 && (
    <span>
      {workTitles.map((t, i) => (
        <>
          {i > 0 && i === workTitles.length - 1 && workTitles.length > 2 && <span>, and </span>}
          {i > 0 && i === workTitles.length - 1 && workTitles.length === 2 && <span> and </span>}
          {i > 0 && i < workTitles.length - 1 && <span>, </span>}
          <a href={postLinks[i]} class="no-underline hover:underline hover:decoration-dotted">{t}</a>
        </>
      ))}
      <span> - </span>
    </span>
  )}
  {role && <span>{role} at </span>}
  {
    link ? (
      <span>
        <>
          <>
            <>
              <!-- prettier-ignore -->
              <a
                href={Array.isArray(link) ? link[0] : link}
                target="_blank"
                class:list={["italic"]}
              >{title}</a><span>,</span>
            </>
          </>
        </>
      </span>
    ) : (
      <span>{title},</span>
    )
  }
  {place && <span>{place},</span>}
  {city && <span>{city},</span>}
  {country && <span>{country},</span>}
  <span
    >{
      Array.isArray(date)
        ? `${moment(date[0]).year()}-${moment(date[1]).year()}`
        : moment(new Date(date)).year()
    }</span
  >
  {
    Array.isArray(link) && link.length > 1 && (
      <span>
        (more
        {link.map((l, i) => {
          if (i === 0) return;
          return (
            <a href={l} target="_blank">
              link{i !== link.length - 1 && ","}
            </a>
          );
        })}
        )
      </span>
    )
  }
</li>
