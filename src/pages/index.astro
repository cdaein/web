---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { site } from "@data/siteMetadata";
import IndexListView from "@components/IndexListView.astro";
import IndexGridView from "@components/IndexGridView.astro";
import { DEFAULT_VIEW } from "@data/constants";

// Load all images from work content at build time
const allWorkImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/content/work/**/*.{png,jpg,jpeg,gif,webp}",
  { eager: true },
);

// Convert to simple record of path -> ImageMetadata
const coverImages: Record<string, ImageMetadata> = {};
for (const [path, module] of Object.entries(allWorkImages)) {
  coverImages[path] = module.default;
}

const workPosts = (
  await getCollection("work", ({ data }) => {
    return import.meta.env.PROD ? data.published === true : true;
  })
).sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

const allPosts = [...workPosts];

const indexViewScript = /*javascript*/ `
  const view = localStorage.getItem("indexView") || "${DEFAULT_VIEW}";
  const listView = document.getElementById("index-list-view");
  const gridView = document.getElementById("index-grid-view");
  if (view === "list") {
    listView?.classList.remove("hidden");
  } else {
    gridView?.classList.remove("hidden");
  }

  // Mark visited posts with checkmark
  const visited = JSON.parse(localStorage.getItem("visitedPosts") || "[]");

  // List view: find h1 inside each visited post and append checkmark
  document
    .querySelectorAll("#index-list-view [data-post-slug]")
    .forEach((li) => {
      if (visited.includes(li.dataset.postSlug)) {
        const h1 = li.querySelector("h1");
        if (h1) {
          const check = document.createElement("span");
          check.textContent = " ✓";
          check.className = "text-cyan-500";
          check.title = "Visited";
          h1.append(check);
        }
      }
    });

  // Grid view: find title span in hover overlay and append checkmark
  document
    .querySelectorAll("#index-grid-view [data-post-slug]")
    .forEach((a) => {
      if (visited.includes(a.dataset.postSlug)) {
        const spans = a.querySelectorAll("span");
        const titleSpan = spans[spans.length - 2]; // title is second-to-last span
        if (titleSpan) {
          const check = document.createElement("span");
          check.textContent = " ✓";
          check.className = "text-cyan-500";
          check.title = "Visited";
          titleSpan.append(check);
        }
      }
    });
`;
---

<Layout title={"Index"} description={site.description}>
  <IndexListView posts={allPosts} class="hidden" />
  <IndexGridView posts={allPosts} coverImages={coverImages} class="hidden" />
</Layout>

<script is:inline set:html={indexViewScript} />
