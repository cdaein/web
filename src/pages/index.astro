---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { site } from "@data/siteMetadata";
import IndexListView from "@components/IndexListView.astro";
import IndexGridView from "@components/IndexGridView.astro";
import { DEFAULT_VIEW } from "@data/constants";

// Load all images from work content at build time
const allWorkImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/content/work/**/*.{png,jpg,jpeg,gif,webp}",
  { eager: true },
);

// Convert to simple record of path -> ImageMetadata
const coverImages: Record<string, ImageMetadata> = {};
for (const [path, module] of Object.entries(allWorkImages)) {
  coverImages[path] = module.default;
}

const workPosts = (
  await getCollection("work", ({ data }) => {
    return import.meta.env.PROD ? data.published === true : true;
  })
).sort((a, b) => {
  return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
});

const allPosts = [...workPosts];
---

<Layout title={"Index"} description={site.description}>
  <IndexListView posts={allPosts} class="hidden" />
  <IndexGridView posts={allPosts} coverImages={coverImages} class="hidden" />
</Layout>

<script is:inline define:vars={{ DEFAULT_VIEW }}>
  (function () {
    const view = localStorage.getItem("indexView") || DEFAULT_VIEW;
    const listView = document.getElementById("index-list-view");
    const gridView = document.getElementById("index-grid-view");
    if (view === "list") {
      listView?.classList.remove("hidden");
    } else {
      gridView?.classList.remove("hidden");
    }
  })();
</script>
