---
import Layout from "../layouts/Layout.astro";
import { getCollection } from "astro:content";
import { site } from "@data/siteMetadata";
import IndexListView from "@components/IndexListView.astro";
import IndexGridView from "@components/IndexGridView.astro";

// Load all images from work content at build time
const allWorkImages = import.meta.glob<{ default: ImageMetadata }>(
  "/src/content/work/**/*.{png,jpg,jpeg,gif,webp}",
  { eager: true },
);

// Convert to simple record of path -> ImageMetadata
const coverImages: Record<string, ImageMetadata> = {};
for (const [path, module] of Object.entries(allWorkImages)) {
  coverImages[path] = module.default;
}

const workPosts = (
  await getCollection("work", ({ data }) => {
    return import.meta.env.PROD ? data.published === true : true;
  })
)
  .sort((a, b) => {
    return new Date(b.data.date).getTime() - new Date(a.data.date).getTime();
  });

const allPosts = [...workPosts];

const initViewScript = /*javascript*/ `
  document.addEventListener('DOMContentLoaded', () => {
    const savedView = localStorage.getItem('indexView') || 'list';
    document.getElementById('index-list-view')?.classList.toggle('hidden', savedView === 'grid');
    document.getElementById('index-grid-view')?.classList.toggle('hidden', savedView === 'list');
  });
`;
---

<Layout title={"Index"} description={site.description}>
  <IndexListView posts={allPosts} />
  <IndexGridView posts={allPosts} coverImages={coverImages} class="hidden" />
</Layout>

<script is:inline set:html={initViewScript} />
